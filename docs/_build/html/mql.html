
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>MQL - Metadata Query Language &#8212; MetaCat  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/nature.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Regular Expressions Cheat Sheet" href="regexp.html" />
    <link rel="prev" title="MetaCat Web API" href="webapi.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="regexp.html" title="Regular Expressions Cheat Sheet"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="webapi.html" title="MetaCat Web API"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">MetaCat  documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">MQL - Metadata Query Language</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="mql-metadata-query-language">
<h1>MQL - Metadata Query Language<a class="headerlink" href="#mql-metadata-query-language" title="Permalink to this headline">¶</a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>One of the functions of the Metadata Database is to produce list of files matching a set of crieria specidied
by the user. The product has its own simple language to write these queries in called MQL (pronpounced: MEE-quel,
like “sequel”, but with M). MQL is a language to describe queries against the metadata database.
A query produces a set of files. The order of files in the returned set is not guaranteed and can not be
relied on.</p>
<p>There are 2 classes of queries - file queries and dataset queries. File queries return list of files
matching specified criteria and dataset queries list datasets.</p>
</section>
<section id="file-queries">
<h2>File Queries<a class="headerlink" href="#file-queries" title="Permalink to this headline">¶</a></h2>
<section id="simple-query">
<h3>Simple Query<a class="headerlink" href="#simple-query" title="Permalink to this headline">¶</a></h3>
<p>The simplest MQL query you can write is a <em>Dataset Query</em>, which looks like this:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">files</span> <span class="k">from</span> <span class="n">MyScope</span><span class="p">:</span><span class="n">MyDataset</span>
</pre></div>
</div>
<p>This query simply returns all the files included in the dataset “MyScope:MyDataset”.</p>
<p>You can also specify multiple datasets in the same query:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">files</span> <span class="k">from</span> <span class="n">MyScope</span><span class="p">:</span><span class="n">MC1</span><span class="p">,</span> <span class="n">MyScope</span><span class="p">:</span><span class="n">MC2</span><span class="p">,</span> <span class="n">AnotherScope</span><span class="p">:</span><span class="n">MC</span>
</pre></div>
</div>
<p>Also, you can use wildcards in the dataset name (but not in the scope name). If the dataset name is in quotes,
it is interpreted as an SQL wildcard.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">files</span> <span class="k">from</span> <span class="n">MyScope</span><span class="p">:</span><span class="ss">&quot;MC%&quot;</span><span class="p">,</span> <span class="n">AnotherScope</span><span class="p">:</span><span class="n">MC</span>
</pre></div>
</div>
<p>Note that you have to use database wildcard notation where ‘%’ matches any string, including empty string, and ‘_’ matches any single
character.</p>
<p>If you want to select all files from all known datasets, you can do this:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">files</span> <span class="k">from</span> <span class="ss">&quot;%&quot;</span>
        <span class="k">where</span> <span class="n">run</span><span class="o">=</span><span class="mi">1234</span>
</pre></div>
</div>
<p>The “from &lt;dataset&gt;” part is optional. If you want to select files from all datasets and even files not included
into any dataset, you can omit the “from …” portion:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">files</span> <span class="k">where</span> <span class="n">data_type</span><span class="o">=</span><span class="ss">&quot;mc&quot;</span>
</pre></div>
</div>
</section>
<section id="metadata-filtering">
<h3>Metadata Filtering<a class="headerlink" href="#metadata-filtering" title="Permalink to this headline">¶</a></h3>
<p>Results of any query can be filtered by adding some metadata criteria expression, called <em>meta-filter</em>:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">files</span> <span class="k">from</span> <span class="n">MyScope</span><span class="p">:</span><span class="n">MyDataset</span>
        <span class="k">where</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span>
</pre></div>
</div>
<p>This will return all the files in the dataset, which have a floating point metadata field named “x” with value greater than 0.5. A meta-filter can be more complicated:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">files</span> <span class="k">from</span> <span class="n">MyScope</span><span class="p">:</span><span class="n">MyDataset</span>
        <span class="k">where</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span> <span class="k">and</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">.</span><span class="mi">5</span>
                <span class="k">and</span> <span class="n">run</span> <span class="o">=</span> <span class="mi">123</span>
                <span class="k">and</span> <span class="p">(</span> <span class="k">type</span><span class="o">=</span><span class="ss">&quot;MC&quot;</span> <span class="k">or</span> <span class="k">type</span><span class="o">=</span><span class="ss">&quot;Data&quot;</span> <span class="p">)</span>
</pre></div>
</div>
<p>Generally, all white space is ignored in MQL.</p>
</section>
<section id="combining-queries">
<h3>Combining Queries<a class="headerlink" href="#combining-queries" title="Permalink to this headline">¶</a></h3>
<p>Queries can be combined using boolean operations <em>union</em>, <em>join</em>, and subtraction to produce new queries:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">union</span><span class="p">(</span>
        <span class="n">files</span> <span class="k">from</span> <span class="n">MC</span><span class="p">:</span><span class="n">Cosmics</span>
                <span class="k">where</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span> <span class="k">and</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">.</span><span class="mi">5</span>
        <span class="n">files</span> <span class="k">from</span> <span class="n">MC</span><span class="p">:</span><span class="n">Beam</span> <span class="k">where</span> <span class="n">e</span> <span class="o">=</span> <span class="mi">10</span>
<span class="p">)</span>
</pre></div>
</div>
<p>This query will return files from both datasets. Even if the individual queries happen to produce overallping
sets of files, each file will appear only <em>once</em> in the results of the <em>union</em> query.</p>
<p>Queries can be <em>joined</em> to procude the intersection of the results of individual queries:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">join</span><span class="p">(</span>
        <span class="n">files</span> <span class="k">from</span> <span class="n">MC</span><span class="p">:</span><span class="k">All</span>
                <span class="k">where</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span> <span class="k">and</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">.</span><span class="mi">5</span>
        <span class="n">files</span> <span class="k">from</span> <span class="n">MC</span><span class="p">:</span><span class="k">All</span>
                <span class="k">where</span> <span class="n">e</span> <span class="o">=</span> <span class="mi">10</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Of course this is equivalent to:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">files</span> <span class="k">from</span> <span class="n">MC</span><span class="p">:</span><span class="k">All</span>
        <span class="k">where</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span> <span class="k">and</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">.</span><span class="mi">5</span> <span class="k">and</span> <span class="n">e</span> <span class="o">=</span> <span class="mi">10</span>
</pre></div>
</div>
<p>Queries can be subtracted from each other, which means the resulting set will be boolean subtraction of second query
result set from the first:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">files</span> <span class="k">from</span> <span class="n">MC</span><span class="p">:</span><span class="n">Beam</span> <span class="k">where</span> <span class="n">e1</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="o">-</span> <span class="n">files</span> <span class="k">from</span> <span class="n">MC</span><span class="p">:</span><span class="n">Exotics</span>
</pre></div>
</div>
<p>Although is it not necessary in this example, you can use parethesis and white space to make the query more readable:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">files</span> <span class="k">from</span> <span class="n">MC</span><span class="p">:</span><span class="n">Beam</span> <span class="k">where</span> <span class="n">e1</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span>
<span class="o">-</span> <span class="p">(</span><span class="n">files</span> <span class="k">from</span> <span class="n">MC</span><span class="p">:</span><span class="n">Exotics</span> <span class="k">where</span> <span class="k">type</span> <span class="o">=</span> <span class="ss">&quot;abcd&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Also, you can use square and curly brackets as an alternative to using explicit words “union” and “join” respectively.
The following two queries are equivalent:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">union</span> <span class="p">(</span>
        <span class="n">files</span> <span class="kn">from</span> <span class="nn">s</span><span class="p">:</span><span class="n">A</span><span class="p">,</span>
        <span class="n">join</span><span class="p">(</span>
                <span class="n">files</span> <span class="kn">from</span> <span class="nn">s</span><span class="p">:</span><span class="n">B</span><span class="p">,</span>
                <span class="n">files</span> <span class="kn">from</span> <span class="nn">s</span><span class="p">:</span><span class="n">C</span>
        <span class="p">)</span>
<span class="p">)</span>

<span class="p">[</span>
        <span class="n">files</span> <span class="kn">from</span> <span class="nn">s</span><span class="p">:</span><span class="n">A</span><span class="p">,</span>
        <span class="p">{</span>
                <span class="n">files</span> <span class="kn">from</span> <span class="nn">s</span><span class="p">:</span><span class="n">B</span><span class="p">,</span>
                <span class="n">files</span> <span class="kn">from</span> <span class="nn">s</span><span class="p">:</span><span class="n">C</span>
        <span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
</section>
<section id="external-filters">
<h3>External Filters<a class="headerlink" href="#external-filters" title="Permalink to this headline">¶</a></h3>
<p>The Meatadata Database Query Engine lets the user add custom Python code to be used as a more complicated
operations on the file sets. They in the Query Language, they are invoked using “filter” keyword:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">filter</span> <span class="n">sample</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">)(</span> <span class="n">files</span> <span class="k">from</span> <span class="n">s</span><span class="p">:</span><span class="n">A</span> <span class="p">)</span>
</pre></div>
</div>
<p>Here, <em>filter</em> the the keyword, <em>sample</em> is the name of the Python function to be used to filter the results
of the argument query (simple “files from s:A” query in this case). As you can see, you can pass some
parameters to the function (the number 0.5).</p>
<section id="standard-metacat-filters">
<h4>Standard MetaCat Filters<a class="headerlink" href="#standard-metacat-filters" title="Permalink to this headline">¶</a></h4>
<p>MetaCat provides several general purpose filters:</p>
<p><strong>every_nth</strong> the filter has 2 integer parameters - <code class="docutils literal notranslate"><span class="pre">n</span></code> and <code class="docutils literal notranslate"><span class="pre">i</span></code> and takes single file set as input.
It returns every <code class="docutils literal notranslate"><span class="pre">n</span></code>-th file, starting from <code class="docutils literal notranslate"><span class="pre">i</span></code>. For example, if a dataset has files A0, A1, A2, A3, A4, A5, …,
and the query looks like this:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">filter</span> <span class="n">every_nth</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)(</span> <span class="n">files</span> <span class="k">from</span> <span class="n">s</span><span class="p">:</span><span class="n">A</span> <span class="p">)</span>
</pre></div>
</div>
<p>then the filter will return files A1, A4, …</p>
<p>Note that MetaCat does not guarantee that the underlying query (files from s:A) will always return files
in the same order. Therefore, strictly speaking, every_nth filter may return different results even if the
source dataset does not change.</p>
<p>If you need more reproducibility, you can use <code class="docutils literal notranslate"><span class="pre">hash</span></code> filter:</p>
<p><strong>hash</strong> filter has the same 2 parameters as the <code class="docutils literal notranslate"><span class="pre">every_nth</span></code> filter (<code class="docutils literal notranslate"><span class="pre">n</span></code> and <code class="docutils literal notranslate"><span class="pre">i</span></code>) and takes single input file set, but it
uses hash of file id modulo <code class="docutils literal notranslate"><span class="pre">n</span></code> to compare to <code class="docutils literal notranslate"><span class="pre">i</span></code> to select approximately every <code class="docutils literal notranslate"><span class="pre">n</span></code>-th file. Notice that the number
of files selected by this filter may differ significantly from <code class="docutils literal notranslate"><span class="pre">1/n</span></code> for small file sets.</p>
<p>It is guaranteed that the results of the <code class="docutils literal notranslate"><span class="pre">hash</span></code> filter with the same <code class="docutils literal notranslate"><span class="pre">n</span></code> and different <code class="docutils literal notranslate"><span class="pre">i</span></code> will never intersect.
The same is not necesarily true for <code class="docutils literal notranslate"><span class="pre">every_nth</span></code> filter simply because the order, in which files are seen by the filter
may change from query to query, although this is highly unlikely.</p>
<p><strong>sample</strong> the filter has one argument - a floating point fraction <code class="docutils literal notranslate"><span class="pre">f</span></code> from 0 to 1. It works the same way as the <code class="docutils literal notranslate"><span class="pre">every_nth</span></code> in the
sense that <code class="docutils literal notranslate"><span class="pre">sample</span></code> selects <code class="docutils literal notranslate"><span class="pre">1/n</span></code> files from the set, starting from first. The following queries will produce the same results:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">filter</span> <span class="n">sample</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="p">)(</span> <span class="n">files</span> <span class="k">from</span> <span class="n">s</span><span class="p">:</span><span class="n">A</span> <span class="p">)</span>
<span class="n">filter</span> <span class="n">every_nth</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">0</span><span class="p">)(</span> <span class="n">files</span> <span class="k">from</span> <span class="n">s</span><span class="p">:</span><span class="n">A</span> <span class="p">)</span>
</pre></div>
</div>
<p><strong>mix</strong> - <code class="docutils literal notranslate"><span class="pre">mix</span></code> filter can be used to pick files from multiple datasets. It takes variable number of floating point arguments (<code class="docutils literal notranslate"><span class="pre">fractions</span></code>)
and the same number of input file sets. The files from the input sets will be picked proportinally to the <code class="docutils literal notranslate"><span class="pre">fractions</span></code>. Fractions do not have
to add up to 1.0. The filter will run until it reaches the end of one of the input datasets. For example:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">filter</span> <span class="n">sample</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">)(</span>
    <span class="n">files</span> <span class="k">from</span> <span class="n">s</span><span class="p">:</span><span class="n">A</span><span class="p">,</span>
    <span class="n">files</span> <span class="k">from</span> <span class="n">s</span><span class="p">:</span><span class="n">B</span><span class="p">,</span>
    <span class="n">files</span> <span class="k">from</span> <span class="n">s</span><span class="p">:</span><span class="k">C</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The output will have approximately 2 files from dataset B and 5 files from dataset C for every file from dataset A.</p>
<p>Even if a file appears in more than one of the input file sets, it will not be returned several times.</p>
</section>
<section id="user-defined-filters">
<h4>User Defined Filters<a class="headerlink" href="#user-defined-filters" title="Permalink to this headline">¶</a></h4>
<p>User-defined filters are used to extend MetaCat functionality and as a way to access external metadata and use it to further filter the file sets
and to inject metadata from external sources into MetaCat query.</p>
<p>A user can define their own filters by supplying a class derived from <code class="docutils literal notranslate"><span class="pre">MetaCatFiler</span></code> class imported from <code class="docutils literal notranslate"><span class="pre">metacat.filters</span></code>.
The class may have a constructor, which receives a dictionary with configuration parameters and must have a method called <code class="docutils literal notranslate"><span class="pre">filter</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">metacat.filters</span> <span class="kn">import</span> <span class="n">MetaCatFiler</span>

<span class="k">class</span> <span class="nc">MyFilter</span><span class="p">(</span><span class="n">MetaCatFiler</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DataSource</span> <span class="o">=</span> <span class="o">...</span>

    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">key_value</span><span class="p">):</span>
        <span class="n">input_set</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">input_set</span><span class="p">:</span>
            <span class="n">external_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DataSource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">if</span> <span class="o">...</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">Metadata</span><span class="p">[</span><span class="s2">&quot;extra_field&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">some_data</span>
                <span class="k">yield</span> <span class="n">f</span>
</pre></div>
</div>
<p>First argument of the <code class="docutils literal notranslate"><span class="pre">filter</span></code> method is the list of one or more input file sets. They are results of MQL subqueries passed to the filter as inputs.
Each input file set is an iterable, not lists. If necessary, the input file set can be converted to a list as <code class="docutils literal notranslate"><span class="pre">list(file_set)</span></code>, but that needs to
be done with caution because that will force fetching the entire file set into memory, and that can be very big.</p>
<p>After first parameter, the <code class="docutils literal notranslate"><span class="pre">filter</span></code> method can accept some additional positional and keywird parameters passed from MQL. For example, MQL query like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">filter</span> <span class="n">my_filter</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">pi</span><span class="o">=</span><span class="mf">3.14</span><span class="p">,</span> <span class="n">e</span><span class="o">=</span><span class="mf">2.718</span><span class="p">)</span> <span class="p">(</span>
    <span class="n">files</span> <span class="kn">from</span> <span class="nn">user</span><span class="p">:</span><span class="n">dataset_a</span><span class="p">,</span>
    <span class="n">files</span> <span class="kn">from</span> <span class="nn">group</span><span class="p">:</span><span class="n">dataset_b</span> <span class="n">where</span> <span class="n">x</span><span class="o">=</span><span class="mi">5</span>
<span class="p">)</span>
</pre></div>
</div>
<p>will call the filter() method with the following arguments:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">filter_object</span><span class="o">.</span><span class="n">filter</span><span class="p">([</span><span class="n">file_set_a</span><span class="p">,</span> <span class="n">file_set_b</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">pi</span><span class="o">=</span><span class="mf">3.14</span><span class="p">,</span> <span class="n">e</span><span class="o">=</span><span class="mf">2.18</span><span class="p">)</span>
<span class="o">...</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">filter</span></code> method is expected to generate a list of file object from the input file sets, possibly augmenting their metadata with some
data.</p>
<p>MetaCat will create the filter object only once and then call its <code class="docutils literal notranslate"><span class="pre">filter</span></code> method for each query. Thus, the filter object may have some persistent state,
but that feature should be used with caution because:</p>
<blockquote>
<div><ul class="simple">
<li><p>MetaCat server runs in multiple instances on multiple servers, and the instances do not communicate with each other.</p></li>
<li><p>MetaCat server instance is a multithreaded process and queries are executed on concurrent threads, so some sort of inter-thread synchronization mechanism may need to be used.</p></li>
</ul>
</div></blockquote>
</section>
</section>
<section id="common-namesaces">
<h3>Common Namesaces<a class="headerlink" href="#common-namesaces" title="Permalink to this headline">¶</a></h3>
<p>Typically (but not necessarily), all the datasets mentioned in a query refer to the same namespace.
You can avoid repeting the same namespace using “with” clause. The following are equivalent:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;s&quot;</span>
<span class="p">{</span>
        <span class="n">files</span> <span class="kn">from</span> <span class="nn">B</span><span class="p">,</span>
        <span class="n">files</span> <span class="kn">from</span> <span class="nn">C</span>
<span class="p">}</span>

<span class="p">{</span>
        <span class="n">files</span> <span class="kn">from</span> <span class="nn">s</span><span class="p">:</span><span class="n">B</span><span class="p">,</span>
        <span class="n">files</span> <span class="kn">from</span> <span class="nn">s</span><span class="p">:</span><span class="n">C</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Each “with” clause has its scope limited to the immediate query it is attached to. For example, the following query
is invalid:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">namespace</span><span class="o">=</span><span class="ss">&quot;s&quot;</span>
        <span class="n">files</span> <span class="k">from</span> <span class="n">A</span> <span class="o">-</span> <span class="n">files</span> <span class="k">from</span> <span class="n">B</span>
</pre></div>
</div>
<p>It is invalid becaise the “with” clause applies only to the query it is immediately attached to - “files from A”,
but not to “files from B”, so second dataset query lacks the namespace specification for the dataset B.</p>
<p>Here is how it can be corrected:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">namespace</span><span class="o">=</span><span class="ss">&quot;s&quot;</span>
        <span class="p">(</span><span class="n">files</span> <span class="k">from</span> <span class="n">A</span> <span class="o">-</span> <span class="n">files</span> <span class="k">from</span> <span class="n">B</span><span class="p">)</span>
</pre></div>
</div>
<p>And the outer “with” clause can be overridden by the inner clause:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">namespace</span> <span class="o">=</span> <span class="ss">&quot;x&quot;</span>
        <span class="k">union</span> <span class="p">(</span>
                <span class="n">files</span> <span class="k">from</span> <span class="n">A</span><span class="p">,</span>
                <span class="k">with</span> <span class="n">namespace</span> <span class="o">=</span> <span class="ss">&quot;y&quot;</span>
                        <span class="k">join</span><span class="p">(</span>
                                <span class="n">files</span> <span class="k">from</span> <span class="n">B</span><span class="p">,</span>
                                <span class="n">files</span> <span class="k">from</span> <span class="k">C</span>
                        <span class="p">),</span>
                <span class="n">files</span> <span class="k">from</span> <span class="n">D</span>
        <span class="p">)</span>
</pre></div>
</div>
<p>In this example, datasets A and D will be assumed to be in the namespace “x”, and datasets B and C - in
namespace “y”.</p>
<p>Of course, explicit namespace specification overrides the one specified using “with”:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">namespace</span> <span class="o">=</span> <span class="ss">&quot;x&quot;</span>
        <span class="k">union</span> <span class="p">(</span>
                <span class="n">files</span> <span class="k">from</span> <span class="n">A</span><span class="p">,</span>
                <span class="n">files</span> <span class="k">from</span> <span class="n">y</span><span class="p">:</span><span class="n">B</span><span class="p">,</span>
                <span class="n">files</span> <span class="k">from</span> <span class="k">C</span>
        <span class="p">)</span>
</pre></div>
</div>
<p>This will return union of datasets “x:A”, “y:B” and “x:C”.</p>
</section>
</section>
<section id="metadata-comparison">
<h2>Metadata Comparison<a class="headerlink" href="#metadata-comparison" title="Permalink to this headline">¶</a></h2>
<p>MQL supports the following comparison operators: &lt;, &lt;=, &gt;, &gt;=, ==, !=
The following operators can be used for string matching using regular expressions:</p>
<blockquote>
<div><ul class="simple">
<li><p>metatada_name ~ “pattern” - parameter matches the pattern</p></li>
<li><p>~* - match ignoring case</p></li>
<li><p>!~ - no match</p></li>
<li><p>!~* - no match ignoring case</p></li>
</ul>
</div></blockquote>
<p>For example:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">files</span> <span class="k">from</span> <span class="n">dune</span><span class="p">:</span><span class="k">all</span> <span class="k">where</span>
    <span class="n">DUNE_data</span><span class="p">.</span><span class="k">comment</span> <span class="n">present</span>
    <span class="k">and</span> <span class="n">DUNE_data</span><span class="p">.</span><span class="n">detector_config</span> <span class="o">~</span> <span class="ss">&quot;FELIX&quot;</span>
</pre></div>
</div>
</section>
<section id="array-or-dictionary-elements-access">
<h2>Array or Dictionary Elements Access<a class="headerlink" href="#array-or-dictionary-elements-access" title="Permalink to this headline">¶</a></h2>
<p>If the metadata parameter is an array or a dictionary, you can refer to its specific element using square brackets:</p>
<p>Assume the file metadata has the following parameters:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;run_type&quot;</span><span class="p">:</span>       <span class="s2">&quot;calibration&quot;</span><span class="p">,</span>
    <span class="nt">&quot;trigger_mask&quot;</span><span class="p">:</span>   <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
    <span class="nt">&quot;trigger_bits&quot;</span><span class="p">:</span>
    <span class="p">{</span>
        <span class="nt">&quot;muon&quot;</span><span class="p">:</span>       <span class="mi">1</span><span class="p">,</span>
        <span class="nt">&quot;electron&quot;</span><span class="p">:</span>   <span class="mi">0</span>
    <span class="p">},</span>
    <span class="nt">&quot;modules&quot;</span><span class="p">:</span>        <span class="p">[</span><span class="s2">&quot;a1&quot;</span><span class="p">,</span> <span class="s2">&quot;a2&quot;</span><span class="p">,</span> <span class="s2">&quot;a3&quot;</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Then:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">trigger_bits[&quot;muon&quot;]</span> <span class="pre">==</span> <span class="pre">1</span></code> - will match</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">trigger_bits[&quot;proton&quot;]</span> <span class="pre">==</span> <span class="pre">1</span></code> - will not match</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">trigger_mask[3]</span> <span class="pre">==</span> <span class="pre">0</span></code> - will match</p></li>
</ul>
</div></blockquote>
<p>Also, you can use subscripts <code class="docutils literal notranslate"><span class="pre">[any]</span></code> as “any element of” and <code class="docutils literal notranslate"><span class="pre">[all]</span></code> as “all elements of” a dictionary or an array:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">trigger_bits[any]</span> <span class="pre">==</span> <span class="pre">1</span></code> - will match</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">trigger_bits[any]</span> <span class="pre">!=</span> <span class="pre">1</span></code> - will match</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">trigger_bits[all]</span> <span class="pre">==</span> <span class="pre">1</span></code> - will not match</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">trigger_bits[all]</span> <span class="pre">!=</span> <span class="pre">1</span></code> - will not match</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">trigger_bits[all]</span> <span class="pre">&lt;</span> <span class="pre">2</span></code> - will match</p></li>
</ul>
</div></blockquote>
<p>You can also use <code class="docutils literal notranslate"><span class="pre">in</span></code> and <code class="docutils literal notranslate"><span class="pre">not</span> <span class="pre">in</span></code> to check if a value is contained in the array:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;a1&quot;</span> <span class="pre">in</span> <span class="pre">modules</span></code> - will match, equivalent to <code class="docutils literal notranslate"><span class="pre">modules[any]</span> <span class="pre">=</span> <span class="pre">&quot;a1&quot;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;xyz&quot;</span> <span class="pre">not</span> <span class="pre">in</span> <span class="pre">modules</span></code> - will match, equivalent to <code class="docutils literal notranslate"><span class="pre">modules[all]</span> <span class="pre">!=</span> <span class="pre">&quot;xyz&quot;</span></code> or <code class="docutils literal notranslate"><span class="pre">!(modules[any]</span> <span class="pre">=</span> <span class="pre">&quot;xyz&quot;)</span></code></p></li>
</ul>
</div></blockquote>
<p>Note that while <cite>trigger_bits[all] != 1</cite> will not match, <cite>!(trigger_bits[all] == 1)</cite> will match. In general, the following pairs of expressions are
equal:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">array[all]</span> <span class="pre">!=</span> <span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">!(array[any]</span> <span class="pre">==</span> <span class="pre">x)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">array[any]</span> <span class="pre">!=</span> <span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">!(array[all]</span> <span class="pre">==</span> <span class="pre">x)</span></code></p></li>
</ul>
</div></blockquote>
<p>To use size of the array in an expression, you len(): <code class="docutils literal notranslate"><span class="pre">len(trigger_mask)</span> <span class="pre">&gt;</span> <span class="pre">2</span></code></p>
</section>
<section id="ranges-and-sets">
<h2>Ranges and Sets<a class="headerlink" href="#ranges-and-sets" title="Permalink to this headline">¶</a></h2>
<p>Logical expressins can include ranges or sets of values. Here are some examples:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">in</span> <span class="pre">3:5</span></code> - if x is scalar, equivalent to <code class="docutils literal notranslate"><span class="pre">(x</span> <span class="pre">&gt;=3</span> <span class="pre">and</span> <span class="pre">x</span> <span class="pre">&lt;=</span> <span class="pre">5)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">in</span> <span class="pre">(3,4,5)</span></code> - if x is scalar, equivalent to <code class="docutils literal notranslate"><span class="pre">(x==3</span> <span class="pre">or</span> <span class="pre">x==4</span> <span class="pre">or</span> <span class="pre">x==5)</span></code></p></li>
</ul>
</div></blockquote>
<p>Keep in mind that due to the way the underlying database works, queries with enumerated sets of allowed values work much faster than
those with ranges.
So while the two expressions above are mathematically equivalent for integer numbers, second one will run much faster.</p>
<p>Sets and ranges can be expressed in terms of floating point numbers and strings:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">application.version</span> <span class="pre">in</span> <span class="pre">&quot;1.0&quot;:&quot;2.3&quot;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pi</span> <span class="pre">in</span> <span class="pre">3.131:3.152</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">values[any]</span> <span class="pre">in</span> <span class="pre">3:5</span></code></p></li>
</ul>
</div></blockquote>
<p>Note that <code class="docutils literal notranslate"><span class="pre">array[any]</span> <span class="pre">in</span> <span class="pre">low:high</span></code> is <cite>not</cite> equivalent to <code class="docutils literal notranslate"><span class="pre">(array[any]</span> <span class="pre">&gt;=</span> <span class="pre">low</span> <span class="pre">and</span> <span class="pre">array[any]</span> <span class="pre">&gt;=</span> <span class="pre">low)</span></code> because former expression means:
“any element of the array is in the range” while the later one means “any element is greater or equal <cite>low</cite> and the same or another element
of the array is less or equal <cite>high</cite>”. For example, consider this metadata:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;run_type&quot;</span><span class="p">:</span>       <span class="s2">&quot;calibration&quot;</span><span class="p">,</span>
    <span class="nt">&quot;sequence&quot;</span><span class="p">:</span>  <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span>
    <span class="nt">&quot;bits&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In this case,</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">sequence[any]</span> <span class="pre">in</span> <span class="pre">6:7</span></code> will not match because there is no single element in the array between 6 and 7,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">(sequence[any]</span> <span class="pre">&gt;=</span> <span class="pre">6</span> <span class="pre">and</span> <span class="pre">sequence[any]</span> <span class="pre">&lt;=</span> <span class="pre">7)</span></code> will match because there are some elements below 7 and then some others above 6.</p></li>
</ul>
</div></blockquote>
<p>Similarly, the following expressions are not equivalent:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">(bits[all]</span> <span class="pre">==</span> <span class="pre">0</span> <span class="pre">or</span> <span class="pre">bits[all]</span> <span class="pre">==</span> <span class="pre">1)</span></code> - is false for the metadata above</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bits[all]</span> <span class="pre">in</span> <span class="pre">(0,1)</span></code> - is true</p></li>
</ul>
</div></blockquote>
</section>
<section id="limiting-query-results">
<h2>Limiting Query Results<a class="headerlink" href="#limiting-query-results" title="Permalink to this headline">¶</a></h2>
<p>If you want to see only a portion of the resulting file set, add “limit &lt;n&gt;” to your query:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">files</span> <span class="k">from</span> <span class="n">dune</span><span class="p">:</span><span class="k">all</span> <span class="k">where</span>
    <span class="n">DUNE_data</span><span class="p">.</span><span class="n">detector_config</span><span class="p">.</span><span class="n">list</span> <span class="n">present</span>
    <span class="k">limit</span> <span class="mi">100</span>
</pre></div>
</div>
<p>Limit clause can be added to results of any query:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">union</span> <span class="p">(</span>
    <span class="n">files</span> <span class="k">from</span> <span class="n">dune</span><span class="p">:</span><span class="k">all</span> <span class="k">where</span>
        <span class="n">DUNE_data</span><span class="p">.</span><span class="n">detector_config</span><span class="p">.</span><span class="n">list</span> <span class="n">present</span>
        <span class="k">limit</span> <span class="mi">100</span>
    <span class="p">,</span>
    <span class="n">files</span> <span class="k">from</span> <span class="n">dune</span><span class="p">:</span><span class="n">mc</span> <span class="k">where</span>
        <span class="n">len</span><span class="p">(</span><span class="n">core</span><span class="p">.</span><span class="n">events</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span>
<span class="p">)</span> <span class="k">limit</span> <span class="mi">200</span>
</pre></div>
</div>
<p>Another way of limiting query results is to use built-in “sample” query:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">filter</span> <span class="n">sample</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="p">(</span>
    <span class="n">files</span> <span class="k">from</span> <span class="n">dune</span><span class="p">:</span><span class="k">all</span> <span class="k">where</span>
        <span class="n">DUNE_data</span><span class="p">.</span><span class="n">detector_config</span><span class="p">.</span><span class="n">list</span> <span class="n">present</span>
        <span class="k">limit</span> <span class="mi">10000</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The “sample” filter returns the given fraction of the input query results. In this case, the results will be limited to 1000 (=10000*0.1) files.</p>
</section>
<section id="dataset-queries">
<h2>Dataset Queries<a class="headerlink" href="#dataset-queries" title="Permalink to this headline">¶</a></h2>
<p>Simplest dataset query looks like this:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">datasets</span> <span class="n">test</span><span class="p">:</span><span class="ss">&quot;%&quot;</span>
</pre></div>
</div>
<p>This query will return all the datasets from the “test” namespace.</p>
<p>To add some metadata filtering, add “having” clause to the query:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">datasets</span> <span class="n">test</span><span class="p">:</span><span class="ss">&quot;%&quot;</span>
    <span class="k">having</span> <span class="k">type</span><span class="o">=</span><span class="ss">&quot;mc&quot;</span> <span class="k">and</span> <span class="n">detector</span><span class="o">=</span><span class="ss">&quot;near&quot;</span>
</pre></div>
</div>
<p>Dataset queries can be combined in the same way as the file queries:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">union</span> <span class="p">(</span>
    <span class="n">datasets</span> <span class="n">prod</span><span class="p">:</span><span class="ss">&quot;XYZ%_3&quot;</span><span class="p">,</span>
    <span class="n">datasets</span> <span class="n">mc</span><span class="p">:</span><span class="ss">&quot;XYZ%_4&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
<p>“union”, “join” with their brackets synonims and subtraction are working in the same way as for file queries.</p>
</section>
<section id="combining-file-and-dataset-metadata-filtering">
<h2>Combining File and Dataset Metadata Filtering<a class="headerlink" href="#combining-file-and-dataset-metadata-filtering" title="Permalink to this headline">¶</a></h2>
<p>(this is not fully implemented yet)</p>
<p>Dataset and file metadata filtering can be mixed together:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">files</span> <span class="k">from</span> <span class="n">mc</span><span class="p">:</span><span class="ss">&quot;%&quot;</span>
    <span class="k">having</span> <span class="k">type</span><span class="o">=</span><span class="ss">&quot;nc&quot;</span> <span class="k">and</span> <span class="n">detector</span><span class="o">=</span><span class="ss">&quot;near&quot;</span>            <span class="o">#</span> <span class="n">dataset</span> <span class="n">selection</span>
    <span class="k">where</span> <span class="n">beam</span><span class="o">=</span><span class="ss">&quot;on&quot;</span> <span class="k">and</span> <span class="k">version</span><span class="o">&gt;</span><span class="mi">3</span>                   <span class="o">#</span> <span class="n">files</span> <span class="n">selection</span>
</pre></div>
</div>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">MQL - Metadata Query Language</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#file-queries">File Queries</a><ul>
<li><a class="reference internal" href="#simple-query">Simple Query</a></li>
<li><a class="reference internal" href="#metadata-filtering">Metadata Filtering</a></li>
<li><a class="reference internal" href="#combining-queries">Combining Queries</a></li>
<li><a class="reference internal" href="#external-filters">External Filters</a><ul>
<li><a class="reference internal" href="#standard-metacat-filters">Standard MetaCat Filters</a></li>
<li><a class="reference internal" href="#user-defined-filters">User Defined Filters</a></li>
</ul>
</li>
<li><a class="reference internal" href="#common-namesaces">Common Namesaces</a></li>
</ul>
</li>
<li><a class="reference internal" href="#metadata-comparison">Metadata Comparison</a></li>
<li><a class="reference internal" href="#array-or-dictionary-elements-access">Array or Dictionary Elements Access</a></li>
<li><a class="reference internal" href="#ranges-and-sets">Ranges and Sets</a></li>
<li><a class="reference internal" href="#limiting-query-results">Limiting Query Results</a></li>
<li><a class="reference internal" href="#dataset-queries">Dataset Queries</a></li>
<li><a class="reference internal" href="#combining-file-and-dataset-metadata-filtering">Combining File and Dataset Metadata Filtering</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="webapi.html"
                        title="previous chapter">MetaCat Web API</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="regexp.html"
                        title="next chapter">Regular Expressions Cheat Sheet</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/mql.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="regexp.html" title="Regular Expressions Cheat Sheet"
             >next</a> |</li>
        <li class="right" >
          <a href="webapi.html" title="MetaCat Web API"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">MetaCat  documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">MQL - Metadata Query Language</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, Igor Mandrichenko.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.3.2.
    </div>
  </body>
</html>